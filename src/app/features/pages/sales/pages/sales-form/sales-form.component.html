<div class="flex h-full space-x-4">
  
  <section class="flex-1">
    <div class="mb-4 flex items-center bg-white p-4 rounded-lg shadow-sm">
      <lucide-icon name="search" class="text-primary mr-3 w-5 h-5"></lucide-icon>
      <input type="text" [(ngModel)]="searchQuery" (input)="onSearch()" placeholder="Search product code or name..." 
             class="w-full focus:outline-none text-lg">
    </div>

    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
      <div *ngFor="let product of products" 
           (click)="addToCart(product)"
           class="bg-white p-4 rounded-xl shadow-sm border-b-4 border-transparent hover:border-primary transition cursor-pointer group">
        <div class="h-32 bg-gray-100 rounded-lg mb-3 flex items-center justify-center">
            <lucide-icon name="package" class="text-gray-300 group-hover:text-primary transition w-10 h-10"></lucide-icon>
        </div>
        <h3 class="font-bold text-gray-800">{{ product.name }}</h3>
        <p class="text-primary font-semibold">{{ getBranchStock(product)?.sale_price | currency : 'IDR' : 'Rp. ' : '1.0-0'}}</p>
        <p class="text-xs text-gray-400">Stock: {{ getBranchStock(product)?.quantity }}</p>
      </div>
    </div>
  </section>

  <aside class="w-96 bg-white rounded-4xl border border-border shadow-xl flex flex-col overflow-hidden">
    <div class="p-6 bg-primary text-white">
      <div class="flex justify-between items-center">
        <h2 class="font-black uppercase tracking-widest text-xs">Current Order</h2>
        <lucide-icon name="shopping-cart" class="w-4 h-4 text-white/50"></lucide-icon>
      </div>
    </div>

    <div class="p-4 border-b bg-gray-50/50">
      <label class="text-[9px] font-black text-gray-400 uppercase block mb-2">Customer / Member</label>
      <div class="relative">
        <lucide-icon name="user" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></lucide-icon>
        <select [ngModel]="activeSale().customer_id" (ngModelChange)="onCustomerChange($event)"
                class="w-full pl-10 pr-4 py-3 bg-white border border-gray-200 rounded-xl text-xs font-bold outline-none focus:ring-2 ring-primary/10 transition-all appearance-none">
          <option [value]="null">Walk-in Customer (Guest)</option>
          @for (c of customers; track c.id) {
            <option [value]="c.id">{{ c.name }} ({{ c.mobile }})</option>
          }
        </select>
      </div>

      @if (activeSale().customer_id) {
        <div class="mt-3 p-3 bg-green-50 rounded-xl border border-green-100 flex justify-between items-center animate-in slide-in-from-top-2">
          <div>
            <p class="text-[9px] font-black text-green-600 uppercase">Points Available</p>
            <p class="text-xs font-bold text-green-700">{{ selectedCustomerBalance() | number }} pts</p>
          </div>
          <button (click)="togglePoints()" 
                  [class]="activeSale().appliedPoints > 0 ? 'bg-green-600 text-white' : 'bg-white text-green-600'"
                  class="px-4 py-2 border border-green-200 rounded-lg text-[10px] font-black transition-all">
            {{ activeSale().appliedPoints > 0 ? 'REDEEMED' : 'REDEEM' }}
          </button>
        </div>
      }
    </div>

    <div class="flex-1 overflow-y-auto p-6 space-y-4">
      @for (item of activeSale().items; track item.product_id) {
        <div class="flex justify-between items-start animate-in fade-in slide-in-from-right-2">
          <div class="flex-1">
            <p class="font-bold text-sm text-gray-800">{{ item.name }}</p>
            <div class="flex items-center gap-2 mt-1">
              <button (click)="reduceQuantity(item)" ass="p-1 bg-gray-100 rounded-md"><lucide-icon name="minus" class="w-3 h-3"></lucide-icon></button>
              <span class="text-xs font-mono font-bold">{{ item.quantity }}</span>
              <button (click)="addQuantity(item)" ass="p-1 bg-gray-100 rounded-md"><lucide-icon name="plus" class="w-3 h-3"></lucide-icon></button>
            </div>
          </div>
          <p class="font-black text-sm text-gray-900">{{ (item.quantity * item.price)  | currency : 'IDR' : 'Rp. ' : '1.0-0' }}</p>
        </div>
      }
    </div>
    <div class="p-6 bg-gray-50 space-y-3">
      <div class="flex justify-between items-center text-[10px] font-black text-gray-400 uppercase">
        <span>Discount Amount</span>
        <div class="relative w-24">
          <span class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400">Rp</span>
          <input type="number" [(ngModel)]="manualDiscount"
                class="w-full pl-7 pr-2 py-1 bg-white border rounded text-right font-black text-gray-900">
        </div>
      </div>

      @if (activeSale().appliedPoints > 0) {
        <div class="flex justify-between text-xs font-bold text-green-600">
          <span>Points Redemption</span>
          <span>- {{ (activeSale().appliedPoints * 100) | currency : 'IDR' : 'Rp. ' : '1.0-0' }}</span>
        </div>
      }
      <div class="flex justify-between text-2xl font-black text-gray-900 border-t pt-4">
        <span>Total</span>
        <span class="text-primary">{{ totalPrice() | currency : 'IDR' : 'Rp. ' : '1.0-0' }}</span>
      </div>
      <button (click)="processPayment()" 
              class="w-full bg-primary text-white py-4 rounded-2xl font-black text-lg shadow-lg shadow-primary/20 hover:scale-[1.02] active:scale-95 transition-all">
        PROCESS PAYMENT
      </button>
    </div>
  </aside>

  <div *ngIf="showPaymentModal()" class="fixed inset-0 z-100 flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-md" (click)="closePayment()"></div>
    
    <div class="relative bg-white w-full max-w-2xl rounded-[3rem] shadow-2xl overflow-hidden flex flex-col animate-in zoom-in-95 duration-200">
      <div class="p-8 bg-gray-50 border-b flex justify-between items-center">
        <h2 class="text-2xl font-black text-primary uppercase italic tracking-tighter">Complete Payment</h2>
        <button (click)="closePayment()" class="p-3 hover:bg-white rounded-2xl text-gray-400"><lucide-icon name="x"></lucide-icon></button>
      </div>

      <div class="p-10 grid grid-cols-2 gap-10">
        <div class="space-y-6">
          <div class="p-6 bg-gray-50 rounded-4xl border border-gray-100">
            <label class="text-[10px] font-black text-gray-400 uppercase">Original Subtotal</label>
            <div class="text-xl font-bold text-gray-400 line-through decoration-gray-300">
              Rp {{ (totalPrice() + (activeSale().appliedPoints * 100) + manualDiscount) | number }}
            </div>
            
            <div class="mt-4 space-y-2">
              <div *ngIf="activeSale().appliedPoints > 0" class="flex justify-between items-center text-green-600">
                <span class="text-[10px] font-black uppercase tracking-widest">Points Reward</span>
                <span class="font-bold">- Rp {{ (activeSale().appliedPoints * 100) | number }}</span>
              </div>
              <div *ngIf="manualDiscount > 0" class="flex justify-between items-center text-blue-600">
                <span class="text-[10px] font-black uppercase tracking-widest">Special Discount</span>
                <span class="font-bold">- Rp {{ manualDiscount | number }}</span>
              </div>
            </div>

            <div class="mt-6 pt-6 border-t border-gray-200">
              <label class="text-[10px] font-black text-primary uppercase">Amount to Pay</label>
              <div class="text-4xl font-black text-gray-900 tracking-tighter">
                Rp {{ totalPrice() | number }}
              </div>
            </div>
          </div>
        </div>

        <div class="space-y-6">
          <label class="text-[10px] font-black text-gray-400 uppercase">Payment Breakdown</label>
          
          <div class="space-y-2">
            @for (p of selectedPayments(); track $index) {
              <div class="flex items-center gap-3 p-3 bg-white border-2 border-primary/20 rounded-2xl animate-in slide-in-from-right-2">
                <span class="bg-primary text-white text-[8px] font-black px-2 py-1 rounded uppercase">{{ p.payment_method }}</span>
                <input type="number" [ngModel]="p.amount_paid" (ngModelChange)="updatePaymentAmount($index, $event)"
                      class="w-full flex-1 text-right font-black text-lg border-none focus:ring-0">
                <button (click)="removePayment($index)" class="text-gray-300 hover:text-red-500 transition-colors">
                  <lucide-icon name="minus-circle" class="w-4 h-4"></lucide-icon>
                </button>
              </div>
            }
          </div>

          <div class="grid grid-cols-2 gap-2 mt-4">
            <button (click)="addPaymentMethod('CASH')" 
                    class="py-3 border-2 border-gray-100 rounded-xl font-black text-[10px] uppercase hover:border-primary transition-all">
              + Add Cash
            </button>
            <button (click)="addPaymentMethod('QRIS')" 
                    class="py-3 border-2 border-gray-100 rounded-xl font-black text-[10px] uppercase hover:border-primary transition-all">
              + Add QRIS/Debit
            </button>
          </div>

          <div *ngIf="hasCashPayment()" class="p-4 bg-orange-50 rounded-2xl border border-orange-100 mt-4">
            <div class="flex justify-between items-center text-orange-600">
              <span class="text-[10px] font-black uppercase">Change Due</span>
              <span class="text-xl font-black">Rp {{ calculateChange() | number }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="p-8 bg-gray-50 border-t">
        <button (click)="submitPayment()" 
          [disabled]="hasCashPayment() && (calculateChange() < 0)"
          class="w-full py-6 bg-primary text-white rounded-4xl font-black text-lg uppercase shadow-xl shadow-primary/20 hover:scale-[1.01] active:scale-95 transition-all disabled:opacity-50 disabled:grayscale">
          Confirm & Print Receipt
        </button>
      </div>
    </div>
  </div>

  <app-thermal-receipt 
    [branch]="lastSale()?.branch || {}"
    [items]="lastSale()?.items || []" 
    [total]="lastSale()?.grand_total || 0"
    [cashierName]="lastSale()?.employee || 'Admin'"
    [invoiceNo]="lastSale()?.invoice_no || ''"
    [appliedPoints]="lastSale()?.applied_points || 0"
    [manualDiscount]="lastSale()?.manual_discount || 0"
    [customerNewBalance]="lastSale()?.customer?.points || 0"
    [change]="lastSale()?.change || 0"
    [payments]="lastSale()?.payment_summary || []"
    [activeCustomerName]="lastSale()?.customer?.name || ''"
    [subtotal]="lastSale()?.subtotal || 0">
  </app-thermal-receipt>
</div>